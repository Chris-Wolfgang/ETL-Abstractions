# This workflow runs all branches when a pull request is created. 
# If security settings have been properly configured, any branch that fails this workflow will be blocked from being merged into main and possibly other common branches link develop depending your specific settings

name: PR Checks

permissions:
  contents: read
  
on:
  pull_request:
    branches:
      # List any other branches here that you want this workflow to run on
      - main

jobs:
  build-and-test:
    # Specifies the OS to run this workflow on. You can specify more than one. For a complete and current list, review the [documentation] (https://docs.github.com/en/actions/how-tos/write-workflows/choose-where-workflows-run/choose-the-runner-for-a-job)
    runs-on: ${{ matrix.os }}
    if: github.repository != 'Chris-Wolfgang/repo-template' # Only run in child repos otherwise this will fail because the template does not have any projects
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Solution (Release) - Linux/macOS (exclude .NET Framework projects)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Build main library for each non-Framework target individually
          for fw in netstandard2.0 netstandard2.1 netcoreapp3.1 net5.0 net6.0 net7.0 net8.0 net9.0 net10.0; do
            echo "Building Wolfgang.Etl.Abstractions for $fw"
            dotnet build src/Wolfgang.Etl.Abstractions/Wolfgang.Etl.Abstractions.csproj \
              --no-restore \
              --configuration Release \
              --framework "$fw"
          done  
          
          # Build test project for non-Framework targets
          dotnet build tests/Wolfgang.Etl.Abstractions.Tests.Unit/Wolfgang.Etl.Abstractions.Tests.Unit.csproj \
            --no-restore \
            --configuration Release \
            "-p:TargetFrameworks=netcoreapp3.1;net5.0;net6.0;net7.0;net8.0;net9.0;net10.0"
          
          # Build Net8.0 examples
          for proj in examples/Net8.0/*/*.csproj; do
            if [ -f "$proj" ]; then
              echo "Building $proj"
              dotnet build "$proj" --no-restore --configuration Release
            fi
          done

      - name: Build Solution (Release) - Windows (all target frameworks)
        if: runner.os == 'Windows'
        run: dotnet build --no-restore --configuration Release

      - name: Run Tests and Collect Coverage for Each Test Project (Release)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Test all frameworks on Windows
            dotnet test tests/Wolfgang.Etl.Abstractions.Tests.Unit/Wolfgang.Etl.Abstractions.Tests.Unit.csproj \
              --no-build \
              --configuration Release \
              --collect:"XPlat Code Coverage" \
              --results-directory "./TestResults"
          else
            # Test only .NET 8.0 on Linux/macOS (representative framework)
            dotnet test tests/Wolfgang.Etl.Abstractions.Tests.Unit/Wolfgang.Etl.Abstractions.Tests.Unit.csproj \
              --no-build \
              --configuration Release \
              --framework net8.0 \
              --collect:"XPlat Code Coverage" \
              --results-directory "./TestResults"
          fi

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate Coverage Reports (HTML, TextSummary, GitHub Markdown, CSV)
        run: |
          reportgenerator -reports:"TestResults/**/coverage.cobertura.xml" -targetdir:"CoverageReport" -reporttypes:"Html;TextSummary;MarkdownSummaryGithub;CsvSummary"

      - name: Check Coverage Thresholds
        shell: bash
        run: |
          if [ ! -f CoverageReport/Summary.txt ]; then
            echo "CoverageReport/Summary.txt not found! Coverage report was not generated."
            exit 1
          fi

          failed_projects=""
          while read -r line; do
            module=$(echo "$line" | awk '{print $1}')
            percent=$(echo "$line" | awk '{print $NF}' | tr -d '%' | xargs)
            echo "Checking module: '$module', percent: '$percent'"
            if [[ "$percent" =~ ^[0-9]+$ ]]; then
              if [ "$percent" -lt 80 ]; then
                echo "FAIL: $module is below 80% ($percent%)"
                failed_projects="$failed_projects $module ($percent%)"
              else
                echo "PASS: $module meets coverage ($percent%)"
              fi
            else
              echo "WARNING: extracted percent value '$percent' is not a number!"
            fi
          done < <(grep -E '^[^ ].*[0-9]+%$' CoverageReport/Summary.txt | grep -v '^Summary')

          if [ -n "$failed_projects" ]; then
            echo "The following projects are below 80% line coverage:$failed_projects"
            exit 1
          fi

      - name: Upload coverage results and reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-results-and-report-${{ matrix.os }}
          path: |
            TestResults/
            CoverageReport/

      - name: Install DevSkim CLI
        run: dotnet tool install --global Microsoft.CST.DevSkim.CLI

      - name: Run DevSkim Security Scan (Save output)
        shell: bash
        run: |
          devskim analyze --source-code . --file-format text -E --ignore-rule-ids DS176209 --ignore-globs "**/api/**,**/CoverageReport/**,**/TestResults/**" > devskim-results.txt 2>&1 || true

      - name: Show DevSkim Results in Summary
        if: always()
        shell: bash
        run: |
          if [ -f devskim-results.txt ]; then
            echo "### DevSkim Security Issues Found"
            cat devskim-results.txt
            
            # Check if any issues were found (exit code check from previous step is suppressed)
            if grep -q "found" devskim-results.txt; then
              echo "Security issues detected! Review the report above."
              exit 1
            else
              echo "No security issues found."
            fi
          else
            echo "DevSkim results file not found."
          fi

      - name: Upload DevSkim Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devskim-results-${{ matrix.os }}
          path: devskim-results.txt
